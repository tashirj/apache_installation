#
# Cookbook Name:: http_installation
# Recipe:: default
#
# Copyright 2016, YOUR_COMPANY_NAME
#
# All rights reserved - Do Not Redistribute
#
apache_install_dir=node[:http_installation][:install_dir]

execute 'openresty_package_download' do
  command 'wget http://openresty.org/download/ngx_openresty-1.5.8.1.tar.gz'
  cwd '/opt/'
  not_if { File.exists?("/opt/ngx_openresty*") }
end

bash 'extract_openresty' do
  cwd ::File.dirname(src_filepath)
  code <<-EOH 
    tar -xzf #{src_filename} -C #{apache_install_dir}
    mv #{apache_install_dir}/ngx_openresty-* #{apache_install_dir}/ngx_openresty
    cd #{apache_install_dir}/ngx_openresty
    ./configure --prefix=/opt/openresty --with-pcre-jit --with-pcre --with-http_ssl_module --with-luajit
    make
    make install
    EOH
  not_if { ::File.exists?(apache_install_dir) }
end
#file '/usr/local/openresty/nginx/conf/nginx.conf' do
#  content '<html>This is a placeholder for the home page.</html>'
#  mode '0755'
#  owner 'web_admin'
#  group 'web_admin'
#end
execute 'nginx_configuration_check' do
  command ''
  cwd '/opt/'
  only_if { File.exists?("/opt/openresty/nginx/conf/nginx.conf") }
end



